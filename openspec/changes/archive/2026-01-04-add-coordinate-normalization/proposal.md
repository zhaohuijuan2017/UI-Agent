# 提案: 添加LLM返回坐标的归一化还原支持

## 问题陈述

当前系统在使用LLM视觉API进行UI元素定位时,存在**坐标定位不准确**的问题。

### 根本原因

LLM模型(如智谱AI的GLM-4V)在处理图像时会将图像尺寸**归一化到1000×1000的虚拟空间**中:
- LLM返回的坐标值范围在0到1000之间
- 这种设计使模型不受原始图像分辨率影响,提高了泛化能力
- 但需要在LLM返回元素位置后,将归一化坐标还原为实际像素坐标

### 还原公式

```
实际x坐标 = (归一化x坐标 / 1000) × 图像宽度
实际y坐标 = (归一化y坐标 / 1000) × 图像高度
```

### 当前问题

在 `src/locator/visual_locator.py:393-399` 的 `_locate_with_vision` 方法中:
```python
bbox = item.get("bbox", [])
if len(bbox) >= 4:
    elements.append(
        UIElement(
            bbox=(int(bbox[0]), int(bbox[1]), int(bbox[2]), int(bbox[3])),
            ...
        )
    )
```

代码直接使用LLM返回的坐标值,没有进行归一化还原,导致:
- 当截图尺寸不是1000×1000时,定位的像素坐标完全错误
- 点击和操作位置严重偏离实际UI元素位置
- 视觉定位功能在高分辨率屏幕上失效

## 解决方案概述

### 核心改动

1. **检测坐标类型**: 在解析LLM返回时,智能判断坐标是否为归一化坐标
2. **坐标还原**: 如果检测到归一化坐标(0-1000范围),使用截图实际尺寸进行还原
3. **向后兼容**: 保持对直接返回像素坐标的支持

### 影响范围

- **核心模块**: `src/locator/visual_locator.py` 的 `_locate_with_vision` 方法
- **数据模型**: `src/models/element.py` 的 `UIElement` 类(可能需要添加元数据记录坐标类型)
- **测试覆盖**: 需要添加归一化坐标还原的单元测试

## 实现方式

### 选项A: 自动检测并转换(推荐)

**优点**:
- 对现有API无影响,完全向后兼容
- 自动适应LLM返回的不同坐标格式
- 用户无感知

**缺点**:
- 需要启发式判断,可能存在边界情况

### 选项B: 配置化控制

**优点**:
- 行为明确,可配置
- 便于调试和问题排查

**缺点**:
- 需要修改配置文件
- 用户需要了解LLM的坐标返回格式

## 推荐方案

采用**选项A: 自动检测并转换**,原因:
1. 当前系统未配置坐标格式,默认行为应"正确工作"
2. 可以通过启发式规则(检查坐标是否在0-1000范围)准确判断
3. 如需调试,可添加日志记录坐标转换过程
4. 未来如需更精细控制,可添加配置项而不破坏现有API

## 预期效果

实现后:
- ✅ LLM返回归一化坐标时,自动还原为正确的像素坐标
- ✅ 支持任意分辨率的截图
- ✅ 保持向后兼容,不影响现有代码
- ✅ 视觉定位精度显著提升

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 检测逻辑误判 | 中 | 添加日志记录转换过程,便于调试 |
| 性能影响 | 低 | 仅增加简单的比例计算,开销可忽略 |
| 边界情况 | 低 | 通过单元测试覆盖常见场景 |

## 相关规范增量

- 新增规范: `coordinate-normalization` - 定义坐标归一化还原的需求和场景
