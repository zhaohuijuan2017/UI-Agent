# 任务清单: 坐标归一化还原

## 任务概览

本变更将添加LLM返回的归一化坐标的自动检测和还原功能,解决视觉定位在不同分辨率截图下的精度问题。

---

## 任务1: 添加坐标检测和转换方法

**状态**: ✅ 已完成

**优先级**: 高
**预估时间**: 30分钟
**依赖**: 无

**状态**: ✅ 已完成

### 描述

在 `VisualLocator` 类中添加两个静态方法:
- `_is_normalized_coordinate()`: 检测坐标是否为归一化坐标
- `_denormalize_bbox()`: 将归一化坐标转换为像素坐标

### 验证标准

- [x] 方法已添加到 `src/locator/visual_locator.py`
- [x] 方法签名为 `@staticmethod`
- [x] 包含完整的类型提示和文档字符串
- [x] 代码通过ruff格式检查

### 文件

- `src/locator/visual_locator.py`

---

## 任务2: 修改 `_locate_with_vision` 方法集成坐标转换

**状态**: ✅ 已完成

**优先级**: 高
**预估时间**: 20分钟
**依赖**: 任务1

**状态**: ✅ 已完成

### 描述

修改 `_locate_with_vision` 方法中的bbox解析逻辑,在创建 `UIElement` 之前检测并转换归一化坐标。

### 实现细节

在第393-402行的bbox解析逻辑中:
1. 获取原始bbox
2. 调用 `_is_normalized_coordinate()` 检测
3. 如果是归一化坐标,调用 `_denormalize_bbox()` 转换
4. 输出日志记录转换过程
5. 使用转换后的坐标创建 `UIElement`

### 验证标准

- [x] bbox解析逻辑已更新
- [x] 归一化坐标能正确检测
- [x] 坐标转换计算正确
- [x] 添加了日志输出
- [x] 现有测试用例通过

### 文件

- `src/locator/visual_locator.py`

---

## 任务3: 编写单元测试 - 坐标检测方法

**状态**: ✅ 已完成

**优先级**: 高
**预估时间**: 30分钟
**依赖**: 任务1

### 描述

为 `_is_normalized_coordinate()` 方法编写完整的单元测试,覆盖各种场景。

### 测试用例

- [x] 归一化坐标: `(100, 200, 300, 400)` 在 `(1920, 1080)` 图像 → 返回 `True`
- [x] 像素坐标: `(500, 600, 700, 800)` 在 `(800, 600)` 图像 → 返回 `False`
- [x] 边界情况: 小尺寸图像 `(800, 600)` 与接近坐标 `(400, 300, 600, 450)` → 返回 `False`
- [x] 边界情况: 坐标值等于1000 `(0, 0, 1000, 1000)` 在 `(1920, 1080)` → 返回 `True`
- [x] 边界情况: 零坐标 `(0, 0, 0, 0)` → 返回 `True` (所有坐标≤1000)

### 验证标准

- [x] 测试文件创建在 `tests/unit/test_coordinate_normalization.py`
- [x] 所有测试用例通过
- [x] 测试覆盖率达到100%

### 文件

- `tests/unit/test_coordinate_normalization.py` (新建)

---

## 任务4: 编写单元测试 - 坐标转换方法

**状态**: ✅ 已完成

**优先级**: 高
**预估时间**: 40分钟
**依赖**: 任务1

### 描述

为 `_denormalize_bbox()` 方法编写完整的单元测试,覆盖不同分辨率和边界情况。

### 测试用例

#### 标准分辨率测试
- [x] Full HD (1920×1080): `(500, 500, 600, 600)` → `(960, 540, 1152, 648)`
- [x] 2K (2560×1440): `(0, 0, 500, 1000)` → `(0, 0, 1280, 1440)`
- [x] 4K (3840×2160): `(250, 250, 750, 750)` → `(960, 540, 2880, 1620)`
- [x] HD (1280×720): `(500, 250, 1000, 750)` → `(640, 180, 1280, 540)`

#### 边界情况测试
- [x] 超出右边界: `(900, 500, 1050, 600)` 在 `(1920, 1080)` → x2裁剪为1920
- [x] 超出左边界: `(-50, 100, 200, 300)` → x1裁剪为0
- [x] 超出下边界: `(100, 900, 200, 1050)` 在 `(1920, 1080)` → y2裁剪为1080
- [x] 零宽度: `(500, 500, 500, 600)` → 确保x2至少为x1+1
- [x] 零高度: `(500, 500, 600, 500)` → 确保y2至少为y1+1

#### 精度测试
- [x] 浮点数精度: `(333, 333, 666, 666)` 在 `(1920, 1080)` → 验证计算精度
- [x] 整数转换: 确保所有坐标转换为整数

### 验证标准

- [x] 所有测试用例通过
- [x] 边界值处理正确
- [x] 精度符合要求

### 文件

- `tests/unit/test_coordinate_normalization.py`

---

## 任务5: 编写集成测试 - 视觉定位端到端测试

**状态**: ✅ 已完成

**优先级**: 中
**预估时间**: 1小时
**依赖**: 任务2

### 描述

编写集成测试,验证完整的视觉定位流程在不同分辨率下的正确性。

### 测试场景

- [x] 场景1: 使用1920×1080截图进行元素定位
- [x] 场景2: 使用2560×1440截图进行元素定位
- [x] 场景3: 使用1280×720截图进行元素定位
- [x] 场景4: 验证返回的UIElement.bbox在图像范围内
- [x] 场景5: 验证bbox的中心点计算正确

### 验证标准

- [x] 测试文件创建在 `tests/integration/test_visual_locator_normalization.py`
- [x] 至少覆盖3种不同分辨率
- [x] 所有测试用例通过
- [x] 模拟LLM返回归一化坐标的测试

### 文件

- `tests/integration/test_visual_locator_normalization.py` (新建)

---

## 任务6: 添加性能基准测试

**状态**: ✅ 已完成

**优先级**: 低
**预估时间**: 20分钟
**依赖**: 任务1

### 描述

添加性能测试,确保坐标转换不影响系统性能。

### 测试内容

- [x] 测试单个bbox转换时间 (< 1微秒)
- [x] 测试批量转换100个bbox的时间
- [x] 对比启用转换前后的性能差异

### 验证标准

- [x] 单次转换 < 1微秒
- [x] 批量转换开销可忽略(< 100微秒/100个)
- [x] 性能测试代码添加到测试文件

### 文件

- `tests/performance/test_coordinate_normalization_perf.py` (新建)

---

## 任务7: 代码质量检查

**状态**: ✅ 已完成

**优先级**: 中
**预估时间**: 15分钟
**依赖**: 任务1-6

### 描述

运行代码质量检查工具,确保代码符合项目规范。

### 检查项

- [x] 运行 `ruff check src/locator/visual_locator.py` → 无错误
- [x] 运行 `black src/locator/visual_locator.py` → 格式正确
- [x] 运行 `mypy src/locator/visual_locator.py` → 类型检查通过
- [x] 运行 `pytest tests/unit/test_coordinate_normalization.py` → 所有测试通过
- [x] 测试覆盖率 ≥ 100%

### 验证标准

- [x] 所有质量检查通过
- [x] 无警告或错误
- [x] 代码符合PEP 8规范

---

## 任务8: 更新文档

**状态**: ✅ 已完成

**优先级**: 低
**预估时间**: 30分钟
**依赖**: 任务1-7

### 描述

更新相关文档,说明坐标归一化还原功能。

### 文档更新

- [x] 更新 `README.md` 或相关使用文档,说明坐标自动转换
- [x] 更新 `ARCHITECTURE.md` (如存在),说明坐标处理架构
- [x] 在 `docs/` 目录添加坐标转换说明文档(可选)
- [x] 更新CHANGELOG记录此变更

### 验证标准

- [x] 文档准确描述功能
- [x] 包含使用示例
- [x] 说明坐标检测逻辑

---

## 任务9: 验证和测试

**状态**: ✅ 已完成

**优先级**: 高
**预估时间**: 30分钟
**依赖**: 所有前序任务

### 描述

完整验证整个功能,确保所有需求满足。

### 验证步骤

- [x] 运行完整测试套件: `pytest tests/ -v`
- [x] 运行代码质量检查: `ruff check src/`
- [x] 手动测试: 使用真实截图和LLM API验证定位精度
- [x] 边界测试: 测试极端分辨率(如5120×1440超宽屏)
- [x] 回归测试: 确保现有功能不受影响

### 验证标准

- [x] 所有单元测试通过
- [x] 所有集成测试通过
- [x] 代码质量检查通过
- [x] 手动测试定位准确
- [x] 现有测试用例无回归

---

## 执行顺序

```
任务1 (添加方法)
    ↓
任务2 (集成到视觉定位)
    ↓
任务3 + 任务4 (并行: 单元测试)
    ↓
任务5 (集成测试)
    ↓
任务6 (性能测试) + 任务7 (代码质量) + 任务8 (文档) (并行)
    ↓
任务9 (最终验证)
```

## 总预估时间

约 3.5 - 4 小时

## 并行机会

- 任务3和任务4可以并行进行
- 任务6、7、8可以并行进行

## 阻塞风险

- **风险**: LLM API返回格式变化
- **缓解**: 添加灵活的JSON解析逻辑

- **风险**: 边界情况未完全覆盖
- **缓解**: 通过单元测试全面覆盖

## 回滚计划

如果出现严重问题,可以通过git revert快速回滚:
```bash
git revert <commit-hash>
```

由于是内部方法修改,回滚不会影响外部API。
