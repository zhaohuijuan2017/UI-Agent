# 变更：通过 Markdown 文档定义多步骤操作工作流

## 为什么

当前 UI-Agent 系统专注于单步自动化操作，每次只能执行一个命令。用户在实际工作流程中经常需要：

1. **批量操作**：连续执行一系列相关操作，如打开 IDE → 打开文件 → 跳转行 → 格式化代码
2. **重复任务**：执行固定的操作序列，如部署流程、测试流程等
3. **复杂任务**：需要根据前一步的结果决定后续操作
4. **可复用性**：将常用操作序列保存为可复用的"脚本"

目前系统无法支持多步骤操作，用户需要：
- 手动多次输入命令
- 无法保存和复用操作序列
- 无法根据执行结果进行条件分支

这限制了自动化效率的提升。

## 变更内容

- **新增 `WorkflowExecutor` 类**：解析和执行 Markdown 工作流文档
- **新增 `WorkflowParser` 类**：解析 Markdown 文档，提取操作步骤
- **新增 `WorkflowConfig` 数据模型**：表示工作流配置
- **新增工作流文档格式**：定义 Markdown 工作流文档的语法
- **支持条件分支**：根据前一步执行结果决定执行路径
- **支持可配置重试**：允许为步骤配置重试策略
- **支持混合格式**：自然语言和结构化定义混合使用
- **新增自然语言命令**：如"执行工作流 xxx.md"、"运行步骤 xxx"
- **新增异常类**：`WorkflowParseError`、`WorkflowExecutionError`

## 影响

### 受影响规范
- **新增规范**：`workflow-execution`（工作流执行功能）

### 受影响代码
- `src/workflow/`（新增）：工作流模块
  - `executor.py`：工作流执行器
  - `parser.py`：工作流解析器
  - `models.py`：工作流数据模型
  - `exceptions.py`：工作流异常类
- `src/controller/ide_controller.py`：集成工作流执行功能
- `config/operations/pycharm.yaml`：添加工作流相关操作
- `main.py`：添加工作流命令行接口

### 依赖变更
- **新增依赖**：`markdown-it-py`（Markdown 解析）或使用 `frontmatter` 处理 YAML front matter

### 风险与影响
- **Markdown 格式兼容性**：需要定义清晰的格式规范，避免歧义
- **执行顺序保证**：确保步骤按定义顺序执行
- **错误传播**：步骤失败时的错误处理和传播机制
- **状态管理**：工作流执行过程中的状态维护

### 缓解措施
1. 定义严格的 Markdown 文档格式规范
2. 提供工作流文档验证功能
3. 详细的日志记录每步执行状态
4. 支持工作流预检查（dry-run 模式）

## 验收标准

1. 能够解析 Markdown 格式的工作流文档
2. 能够按顺序执行工作流中的步骤
3. 支持条件分支（基于前一步结果）
4. 支持为步骤配置重试次数和间隔
5. 执行失败时提供清晰的错误信息
6. 支持混合格式（自然语言 + YAML 配置）
7. 单元测试覆盖核心功能
8. 集成测试验证完整工作流执行

## 后续工作

1. 支持工作流嵌套（一个工作流调用另一个工作流）
2. 支持变量和参数替换
3. 支持循环执行
4. 提供工作流编辑器
5. 支持工作流模板库
