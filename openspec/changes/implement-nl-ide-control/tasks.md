# 任务分解：自然语言控制 PyCharm IDE 系统

## 概述

本文档将 `implement-nl-ide-control` 变更分解为可验证的、有序的工作项。

---

## 第一阶段：项目基础设施

### 1.1 项目结构搭建
- [x] 创建模块化目录结构（`src/` 分模块组织）
- [x] 配置 `pyproject.toml` 添加项目依赖
- [x] 配置开发工具（black, ruff, mypy）
- [x] 创建 `.gitignore` 排除敏感和临时文件
- [x] 编写项目 README

**验证**：项目可以正常安装依赖，运行测试通过

**依赖**：无

---

### 1.2 配置系统实现
- [x] 实现配置文件加载器（YAML 格式）
- [x] 创建 PyCharm 操作配置模板
- [x] 实现配置热更新机制
- [x] 添加配置验证（schema validation）

**验证**：能够加载和验证配置文件，配置错误时给出明确提示

**依赖**：1.1

---

## 第二阶段：核心模块实现

### 2.1 自然语言命令解析器
- [x] 实现命令意图分类器
  - 文件操作类（打开、关闭、保存）
  - 编辑操作类（重命名、重构、格式化）
  - 导航操作类（跳转、查找）
  - 运行操作类（运行、调试、测试）
- [x] 实现参数提取器
  - 文件名/路径提取
  - 行号/范围提取
  - 符号名提取（类名、函数名）
- [x] 实现上下文管理器（当前文件、光标位置）
- [x] 添加命令模板和别名支持

**验证**：能够正确解析 "打开 main.py"、"重命名当前函数为 foo" 等命令

**依赖**：1.2

---

### 2.2 屏幕捕获模块
- [x] 实现屏幕截图功能（全屏和窗口级）
- [x] 实现区域截图（指定坐标范围）
- [x] 优化截图性能（缓存、增量捕获）
- [x] 添加截图历史记录（用于调试）

**验证**：能够稳定捕获 PyCharm 窗口截图，响应时间 < 100ms

**依赖**：1.1

---

### 2.3 视觉 UI 定位器
- [x] 集成 GLM-4V-Flash API
- [x] 实现元素检测提示词模板
- [x] 实现坐标解析和验证
- [x] 实现多模态定位策略
  - 主要：视觉检测
  - 备用：OCR 文本识别
  - 回退：固定坐标映射
- [x] 添加定位结果置信度评估

**验证**：能够定位常见 UI 元素（菜单按钮、文件树、编辑器区域），准确率 >= 80%

**依赖**：2.2

---

### 2.4 GUI 自动化执行器
- [x] 实现鼠标操作封装（点击、双击、右键、拖拽）
- [x] 实现键盘操作封装（输入、快捷键）
- [x] 实现操作序列编排器
- [x] 添加操作前验证（元素存在性检查）
- [x] 实现操作后验证（截图对比）
- [x] 添加超时和重试机制

**验证**：能够可靠地执行点击、输入、快捷键操作，成功率 >= 95%

**依赖**：2.3

---

## 第三阶段：系统集成

### 3.1 主控制循环
- [x] 实现命令接收接口（CLI / 交互式）
- [x] 实现命令处理流程编排
  - 解析 → 定位 → 执行 → 验证 → 反馈
- [x] 实现错误处理和恢复
- [x] 添加操作日志记录
- [x] 实现进度反馈机制

**验证**：能够完整处理单个命令的生命周期

**依赖**：2.1, 2.4

---

### 3.2 PyCharm 操作配置
- [x] 定义常用操作配置（至少 20 种）
  - 文件：打开、关闭、保存、新建
  - 编辑：复制、粘贴、撤销、重做
  - 导航：跳转到行、查找文件
  - 重构：重命名、提取方法
  - 运行：运行当前文件、调试
- [x] 为每个操作定义视觉定位规则
- [x] 添加操作前后的状态检查

**验证**：配置文件覆盖 20+ 常用操作，配置格式正确

**依赖**：1.2

---

### 3.3 安全机制
- [x] 实现操作确认机制（破坏性操作）
- [x] 实现操作超时保护
- [x] 添加紧急停止功能
- [x] 实现操作回滚（记录操作历史）

**验证**：危险操作前要求确认，能够紧急停止执行

**依赖**：3.1

---

## 第四阶段：测试与优化

### 4.1 单元测试
- [ ] 命令解析器测试
- [ ] 坐标计算测试
- [ ] 配置加载测试
- [ ] 各模块功能测试

**验证**：单元测试覆盖率 >= 70%

**依赖**：2.1, 2.3, 2.4

---

### 4.2 集成测试
- [ ] 端到端命令执行测试
- [ ] 多步骤操作流程测试
- [ ] 错误场景测试
- [ ] 性能测试

**验证**：集成测试套件通过，平均命令响应时间 < 5 秒

**依赖**：3.1, 3.2

---

### 4.3 视觉测试
- [ ] UI 元素定位准确性测试
- [ ] 不同屏幕分辨率测试
- [ ] 不同 PyCharm 主题测试

**验证**：UI 定位成功率 >= 85%

**依赖**：2.3

---

## 第五阶段：文档与发布

### 5.1 用户文档
- [ ] 编写安装指南
- [ ] 编写使用教程
- [ ] 编写命令参考手册
- [ ] 编写故障排除指南

**验证**：用户能够根据文档独立安装和使用系统

**依赖**：4.2

---

### 5.2 开发者文档
- [ ] 编写架构文档
- [ ] 编写 API 参考文档
- [ ] 编写扩展指南（如何添加新操作）
- [ ] 编写贡献指南

**验证**：新开发者能够根据文档理解架构并添加功能

**依赖**：3.1

---

## 任务依赖关系图

```
1.1 (项目结构)
    ↓
1.2 (配置系统) → 2.1 (命令解析)
                    ↓
    2.2 (截图) → 2.3 (UI定位) → 2.4 (自动化)
                                        ↓
                                3.1 (主控制) + 3.2 (操作配置)
                                        ↓
                                    3.3 (安全)
                                        ↓
                            4.1 (单元测试) + 4.2 (集成测试) + 4.3 (视觉测试)
                                        ↓
                                5.1 (用户文档) + 5.2 (开发者文档)
```

## 可并行执行的任务组

- **并行组 A**：2.2（截图模块）可与 2.1（命令解析）并行
- **并行组 B**：4.1、4.2、4.3（各类测试）可部分并行
- **并行组 C**：5.1、5.2（文档编写）可并行

## 关键里程碑

1. **M1 - 基础设施完成** ✅：任务 1.1, 1.2 完成
2. **M2 - 核心模块完成** ✅：任务 2.1, 2.2, 2.3, 2.4 完成
3. **M3 - 系统集成完成** ✅：任务 3.1, 3.2, 3.3 完成
4. **M4 - 测试完成** ⏳：任务 4.1, 4.2, 4.3 待完成
5. **M5 - 发布就绪** ⏳：任务 5.1, 5.2 待完成
